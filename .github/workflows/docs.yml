name: Documentation

on:
  push:
    branches:
      - main
    tags: ['*']
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      statuses: write
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.12'
      - uses: julia-actions/cache@v2
      - name: Install system fonts
        run: |
          sudo apt-get install -y fonts-dejavu fonts-liberation
          # Meslo LG Nerd Font — full Unicode coverage including braille (U+2800-U+28FF)
          wget -q https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Meslo.tar.xz -O /tmp/meslo.tar.xz \
            && sudo mkdir -p /usr/share/fonts/truetype/meslo-nerd \
            && sudo tar -xJf /tmp/meslo.tar.xz -C /usr/share/fonts/truetype/meslo-nerd \
            || echo "Meslo download failed, trying fallbacks"
          # JetBrains Mono — fallback (no braille, but good for text)
          wget -q https://github.com/JetBrains/JetBrainsMono/releases/download/v2.304/JetBrainsMono-2.304.zip -O /tmp/jbmono.zip \
            && sudo mkdir -p /usr/share/fonts/truetype/jetbrains-mono \
            && sudo unzip -oq /tmp/jbmono.zip -d /usr/share/fonts/truetype/jetbrains-mono \
            || echo "JetBrains Mono download failed"
          # Iosevka — fallback with braille support
          wget -q https://github.com/be5invis/Iosevka/releases/download/v32.5.0/PkgTTF-Iosevka-32.5.0.zip -O /tmp/iosevka.zip \
            && sudo mkdir -p /usr/share/fonts/truetype/iosevka \
            && sudo unzip -oq /tmp/iosevka.zip -d /usr/share/fonts/truetype/iosevka \
            || echo "Iosevka download failed"
          sudo fc-cache -f
      - name: Install dependencies
        run: |
          julia --project=docs -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: docs/node_modules
          key: npm-${{ hashFiles('docs/package-lock.json', 'docs/package.json') }}
      - name: Install VitePress dependencies
        working-directory: docs
        run: npm install
      - name: Restore asset cache
        uses: actions/cache@v4
        with:
          path: |
            docs/src/assets/*.tach
            docs/src/assets/*.gif
            docs/src/assets/examples
            docs/src/assets/readme
            docs/.render_cache.json
          key: doc-assets-${{ hashFiles('docs/generate_assets.jl', 'docs/hero_assets.jl', 'docs/example_apps.jl', 'src/**/*.jl') }}
          restore-keys: |
            doc-assets-
      - name: Generate doc assets
        run: julia --project=docs docs/generate_assets.jl
      - name: Upload assets to release
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view docs-assets || gh release create docs-assets --title "Documentation Assets" --notes "Auto-updated GIF assets for documentation"
          # Upload top-level assets (hero_logo.gif, code_reveal.gif, etc.)
          for f in docs/src/assets/*.gif; do
            [ -f "$f" ] && gh release upload docs-assets "$f" --clobber
          done
          # Upload examples/ GIFs as-is (names are unique)
          for f in docs/src/assets/examples/*.gif; do
            [ -f "$f" ] && gh release upload docs-assets "$f" --clobber
          done
          # Upload readme/ GIFs with readme_ prefix to avoid name collisions
          for f in docs/src/assets/readme/*.gif; do
            [ -f "$f" ] || continue
            name="readme_$(basename "$f")"
            cp "$f" "/tmp/$name"
            gh release upload docs-assets "/tmp/$name" --clobber
          done
      - name: Remove binary assets before VitePress build
        run: |
          find docs/src/assets -name '*.gif' -delete
          find docs/src/assets -name '*.tach' -delete
      - name: Build and deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCUMENTER_KEY: ${{ secrets.DOCUMENTER_KEY }}
          TACHIKOMA_ASSET_BASE: 'https://github.com/kahliburke/Tachikoma.jl/releases/download/docs-assets/'
        run: julia --project=docs docs/make.jl
